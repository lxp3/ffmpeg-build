name: Build FFmpeg

on:
  workflow_dispatch:  # 允许手动触发
  push:
    tags:
      - 'v*'

jobs:
  parse-tag:
    runs-on: ubuntu-latest
    outputs:
      build_linux: ${{ steps.parse.outputs.build_linux }}
      build_wasm: ${{ steps.parse.outputs.build_wasm }}
      build_windows: ${{ steps.parse.outputs.build_windows }}
      version: ${{ steps.parse.outputs.version }}
    steps:
      - id: parse
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          if [[ "$TAG" == *-linux ]]; then
            echo "build_linux=true" >> $GITHUB_OUTPUT
            echo "build_wasm=true" >> $GITHUB_OUTPUT
            echo "build_windows=false" >> $GITHUB_OUTPUT
          elif [[ "$TAG" == *-window ]]; then
            echo "build_linux=false" >> $GITHUB_OUTPUT
            echo "build_wasm=false" >> $GITHUB_OUTPUT
            echo "build_windows=true" >> $GITHUB_OUTPUT
          else
            echo "build_linux=true" >> $GITHUB_OUTPUT
            echo "build_wasm=true" >> $GITHUB_OUTPUT
            echo "build_windows=true" >> $GITHUB_OUTPUT
          fi
          echo "version=${TAG}" >> $GITHUB_OUTPUT

  build-linux-wasm:
    needs: parse-tag
    if: needs.parse-tag.outputs.build_linux == 'true'
    runs-on: ubuntu-latest
    container: quay.io/pypa/manylinux2014_x86_64
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: yum install -y nasm patchelf

      - name: Build Linux (Static)
        working-directory: 1-manylinux2018
        run: ./build-linux.sh
        env:
          ARCH: x86_64
          ENABLE_SHARED: 0

      - name: Build Linux (Shared)
        working-directory: 1-manylinux2018
        run: ./build-linux.sh
        env:
          ARCH: x86_64
          ENABLE_SHARED: 1

      - name: Setup Emscripten
        if: needs.parse-tag.outputs.build_wasm == 'true'
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.51
          actions-cache-folder: 'emsdk-cache'

      - name: Build WASM
        if: needs.parse-tag.outputs.build_wasm == 'true'
        working-directory: 1-manylinux2018
        run: ./build-wasm.sh

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-linux-wasm
          path: 1-manylinux2018/outputs/*.tar.gz

  build-windows:
    needs: parse-tag
    if: needs.parse-tag.outputs.build_windows == 'true'
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            git
            base-devel
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-nasm
            mingw-w64-x86_64-gcc
            make
            diffutils
            tar

      - name: Build Windows (Static)
        working-directory: 1-manylinux2018
        run: |
          export ARCH=x86_64
          export ENABLE_SHARED=0
          ./build-windows.sh

      - name: Build Windows (Shared)
        working-directory: 1-manylinux2018
        run: |
          export ARCH=x86_64
          export ENABLE_SHARED=1
          ./build-windows.sh

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-windows
          path: 1-manylinux2018/outputs/*.tar.gz

  release:
    needs: [parse-tag, build-linux-wasm, build-windows]
    if: always() && (needs.build-linux-wasm.result == 'success' || needs.build-windows.result == 'success')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Linux/WASM artifacts
        if: needs.build-linux-wasm.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-linux-wasm
          path: artifacts/

      - name: Download Windows artifacts
        if: needs.build-windows.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-windows
          path: artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*.tar.gz
          generate_release_notes: true
