name: Build FFmpeg

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  parse-tag:
    runs-on: ubuntu-latest
    outputs:
      build_linux: ${{ steps.parse.outputs.build_linux }}
      build_windows: ${{ steps.parse.outputs.build_windows }}
      version: ${{ steps.parse.outputs.version }}
    steps:
      - id: parse
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          if [[ "$TAG" == *-linux ]]; then
            echo "build_linux=true" >> $GITHUB_OUTPUT
            echo "build_windows=false" >> $GITHUB_OUTPUT
          elif [[ "$TAG" == *-window ]]; then
            echo "build_linux=false" >> $GITHUB_OUTPUT
            echo "build_windows=true" >> $GITHUB_OUTPUT
          else
            echo "build_linux=true" >> $GITHUB_OUTPUT
            echo "build_windows=true" >> $GITHUB_OUTPUT
          fi
          echo "version=${TAG}" >> $GITHUB_OUTPUT

  build-linux:
    needs: parse-tag
    if: needs.parse-tag.outputs.build_linux == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Linux (Static & Shared Parallel)
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            quay.io/pypa/manylinux2014_x86_64 \
            bash -c "yum install -y nasm patchelf && \
                     chmod +x build-linux.sh && \
                     (ENABLE_SHARED=0 ./build-linux.sh & \
                      ENABLE_SHARED=1 ./build-linux.sh & \
                      wait)"

      - name: Build WASM
        run: |
          chmod +x build-wasm.sh
          ./build-wasm.sh

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-linux-artifacts
          path: outputs/*.tar.gz

  build-windows:
    needs: parse-tag
    if: needs.parse-tag.outputs.build_windows == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            git
            base-devel
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-nasm
            make
            diffutils
            tar

      - name: Build Windows (All Toolchains Parallel)
        shell: pwsh
        run: |
          # Define build tasks
          $tasks = @(
            @{ Toolchain = "msvc";  Shared = 0 },
            @{ Toolchain = "msvc";  Shared = 1 },
            @{ Toolchain = "mingw"; Shared = 0 },
            @{ Toolchain = "mingw"; Shared = 1 }
          )

          # Run builds in parallel using background jobs
          $jobs = $tasks | ForEach-Object {
            Start-Job -ScriptBlock {
              param($t, $s)
              cd $using:PWD
              .\build-msvc.ps1 -Toolchain $t -EnableShared $s
            } -ArgumentList $_.Toolchain, $_.Shared
          }

          # Wait for all jobs to complete and output their results
          $jobs | Wait-Job | Receive-Job

          # Check for failures
          if ($jobs | Where-Object { $_.State -ne "Completed" -or $_.ExitCode -ne 0 }) {
            throw "One or more Windows build jobs failed."
          }

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-windows-all-artifacts
          path: outputs/*.tar.gz

  release:
    needs: [parse-tag, build-linux, build-windows]
    if: always() && (needs.build-linux.result == 'success' || needs.build-windows.result == 'success')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: List artifacts
        run: find artifacts -type f -name "*.tar.gz"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*.tar.gz
          generate_release_notes: true
