name: Build FFmpeg

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  parse-tag:
    runs-on: ubuntu-latest
    outputs:
      build_linux: ${{ steps.parse.outputs.build_linux }}
      build_windows: ${{ steps.parse.outputs.build_windows }}
      build_msvc_static: ${{ steps.parse.outputs.build_msvc_static }}
      build_mingw_static: ${{ steps.parse.outputs.build_mingw_static }}
      build_mingw_shared: ${{ steps.parse.outputs.build_mingw_shared }}
      version: ${{ steps.parse.outputs.version }}
    steps:
      - id: parse
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "version=${TAG}" >> $GITHUB_OUTPUT

          # Default: all disabled
          BUILD_LINUX=false
          BUILD_WINDOWS=false
          BUILD_MSVC_STATIC=false
          BUILD_MINGW_STATIC=false
          BUILD_MINGW_SHARED=false

          # Parse tag for specific builds
          if [[ "$TAG" == *-window-msvc-0 ]]; then
            BUILD_WINDOWS=true
            BUILD_MSVC_STATIC=true
          elif [[ "$TAG" == *-window-mingw-0 ]]; then
            BUILD_WINDOWS=true
            BUILD_MINGW_STATIC=true
          elif [[ "$TAG" == *-window-mingw-1 ]]; then
            BUILD_WINDOWS=true
            BUILD_MINGW_SHARED=true
          elif [[ "$TAG" == *-window ]]; then
            BUILD_WINDOWS=true
            BUILD_MSVC_STATIC=true
            BUILD_MINGW_STATIC=true
            BUILD_MINGW_SHARED=true
          elif [[ "$TAG" == *-linux ]]; then
            BUILD_LINUX=true
          else
            BUILD_LINUX=true
            BUILD_WINDOWS=true
            BUILD_MSVC_STATIC=true
            BUILD_MINGW_STATIC=true
            BUILD_MINGW_SHARED=true
          fi

          echo "build_linux=$BUILD_LINUX" >> $GITHUB_OUTPUT
          echo "build_windows=$BUILD_WINDOWS" >> $GITHUB_OUTPUT
          echo "build_msvc_static=$BUILD_MSVC_STATIC" >> $GITHUB_OUTPUT
          echo "build_mingw_static=$BUILD_MINGW_STATIC" >> $GITHUB_OUTPUT
          echo "build_mingw_shared=$BUILD_MINGW_SHARED" >> $GITHUB_OUTPUT

  build-linux:
    needs: parse-tag
    if: needs.parse-tag.outputs.build_linux == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Linux (Static & Shared Parallel)
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            quay.io/pypa/manylinux2014_x86_64 \
            bash -c "yum install -y nasm patchelf && \
                     chmod +x build-linux.sh && \
                     (ENABLE_SHARED=0 ./build-linux.sh & \
                      ENABLE_SHARED=1 ./build-linux.sh & \
                      wait)"

      - name: Build WASM
        run: |
          chmod +x build-wasm.sh
          ./build-wasm.sh

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-linux-artifacts
          path: outputs/*.tar.gz

  build-windows-msvc-static:
    needs: parse-tag
    if: needs.parse-tag.outputs.build_msvc_static == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install MSYS2 dependencies
        shell: cmd
        run: |
          C:\msys64\usr\bin\pacman.exe -Sy --noconfirm mingw-w64-x86_64-nasm make diffutils

      - name: Build Windows MSVC Static
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          .\build-window.ps1 -Toolchain msvc -EnableShared 0

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-windows-msvc-static
          path: outputs/*.tar.gz

  build-windows-mingw-static:
    needs: parse-tag
    if: needs.parse-tag.outputs.build_mingw_static == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            git
            base-devel
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-nasm
            make
            diffutils
            tar

      - name: Build Windows MinGW Static
        shell: msys2 {0}
        run: |
          set -e
          export ARCH=x86_64
          export ENABLE_SHARED=0
          export TOOLCHAIN=mingw
          chmod +x build-window.sh
          ./build-window.sh

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-windows-mingw-static
          path: outputs/*.tar.gz

  build-windows-mingw-shared:
    needs: parse-tag
    if: needs.parse-tag.outputs.build_mingw_shared == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            git
            base-devel
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-nasm
            make
            diffutils
            tar

      - name: Build Windows MinGW Shared
        shell: msys2 {0}
        run: |
          set -e
          export ARCH=x86_64
          export ENABLE_SHARED=1
          export TOOLCHAIN=mingw
          chmod +x build-window.sh
          ./build-window.sh

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-windows-mingw-shared
          path: outputs/*.tar.gz

  release:
    needs: [parse-tag, build-linux, build-windows-msvc-static, build-windows-mingw-static, build-windows-mingw-shared]
    if: always() && (needs.build-linux.result == 'success' || needs.build-windows-msvc-static.result == 'success' || needs.build-windows-mingw-static.result == 'success' || needs.build-windows-mingw-shared.result == 'success')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: List artifacts
        run: find artifacts -type f -name "*.tar.gz"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*.tar.gz
          generate_release_notes: true
